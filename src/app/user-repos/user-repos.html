<div class="mb-4 pb-2 border-b-2 border-orange-200">
    <h2 class="text-lg font-semibold text-orange-800 cursor-default">Konten</h2>
</div>

<!-- Modal for creating/editing repo -->
<app-modal
    [isOpen]="showForm()"
    [title]="isEditMode() ? 'Konto bearbeiten' : 'Neues Konto erstellen'"
    (close)="isEditMode() ? cancelEdit() : toggleForm()"
>
    <form [formGroup]="repoForm" (ngSubmit)="onSubmitRepo()">
        <!-- Repository Name -->
        <div class="mb-4">
            <label for="repoName" class="block text-sm font-medium text-gray-700 mb-2">
                Name *
            </label>
            <input
                type="text"
                id="repoName"
                formControlName="repoName"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                [class.border-red-500]="repoForm.get('repoName')?.invalid && repoForm.get('repoName')?.touched"
                placeholder="z.B. Girokonto, Sparkonto..."
            />
            @if (repoForm.get('repoName')?.invalid && repoForm.get('repoName')?.touched) {
                <p class="text-red-500 text-xs mt-1">Name ist erforderlich (min. 2 Zeichen)</p>
            }
        </div>

        <!-- Description -->
        <div class="mb-4">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                Beschreibung
            </label>
            <textarea
                id="description"
                formControlName="description"
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                placeholder="Optionale Beschreibung..."
            ></textarea>
        </div>

        <!-- Currency and Start Balance -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="currency" class="block text-sm font-medium text-gray-700 mb-2">
                    Währung *
                </label>
                <select
                    id="currency"
                    formControlName="currency"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                >
                    @for (curr of commonCurrencies; track curr.code) {
                        <option [value]="curr.code">{{ curr.name }}</option>
                    }
                </select>
            </div>

            <div>
                <label for="startBalance" class="block text-sm font-medium text-gray-700 mb-2">
                    Startguthaben *
                </label>
                <input
                    type="number"
                    id="startBalance"
                    formControlName="startBalance"
                    step="0.01"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                    [class.border-red-500]="repoForm.get('startBalance')?.invalid && repoForm.get('startBalance')?.touched"
                />
            </div>
        </div>

        <!-- Start Balance Date -->
        <div class="mb-6">
            <label for="startBalanceDate" class="block text-sm font-medium text-gray-700 mb-2">
                Datum des Startguthabens *
            </label>
            <input
                type="date"
                id="startBalanceDate"
                formControlName="startBalanceDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                [class.border-red-500]="repoForm.get('startBalanceDate')?.invalid && repoForm.get('startBalanceDate')?.touched"
            />
        </div>

        <!-- Submit Buttons -->
        <div class="flex justify-end gap-3">
            <button
                type="button"
                (click)="isEditMode() ? cancelEdit() : toggleForm()"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                [disabled]="isSubmitting()"
            >
                Abbruch
            </button>
            <button
                type="submit"
                class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                [disabled]="isSubmitting()"
            >
                {{ isSubmitting() ? 'Speichert...' : (isEditMode() ? 'Aktualisieren' : 'Erstellen') }}
            </button>
        </div>
    </form>
</app-modal>

<nav class="flex flex-col gap-2">
    <!-- option for all money repos combined -->
    <button
        (click)="selectRepo('Alle', '')"
        [class]="selRepo() === 'Alle'
            ? 'bg-orange-100 text-orange-900 border-l-4 border-l-orange-400 px-4 py-2.5 border-y border-r border-gray-200 cursor-pointer transition-all text-left font-medium'
            : 'text-gray-700 border-l-4 border-l-transparent hover:border-l-orange-200 hover:bg-gray-50 px-4 py-2.5 border-y border-r border-transparent cursor-pointer transition-all text-left font-medium'"
    >
        Alle
    </button>

    <!-- Individual repo buttons -->
    @for (repo of allRepos(); track repo.id) {
    <div
        [class]="selRepo() === repo.repoName
            ? 'flex items-center bg-orange-100 border-l-4 border-l-orange-400 border-y border-r border-gray-200'
            : 'flex items-center border-l-4 border-l-transparent hover:border-l-orange-200 hover:bg-gray-50 border-y border-r border-transparent group'"
    >
        <!-- button for repo selection, starts balance and transfers display -->
        <button
            (click)="selectRepo(repo.repoName, repo.startBalanceDate)"
            [class]="selRepo() === repo.repoName
                ? 'text-orange-900 px-4 py-2.5 cursor-pointer transition-all text-left font-medium flex-1 bg-transparent'
                : 'text-gray-700 px-4 py-2.5 cursor-pointer transition-all text-left font-medium flex-1 bg-transparent'"
        >
            {{ repo.repoName }}
        </button>
        <!-- button for repo deletion, starts delete process with delete confirmation modal -->
        <button
            (click)="deleteRepo(repo)"
            [class]="selRepo() === repo.repoName
                ? 'text-red-600 hover:text-red-800 px-3 py-2.5 transition-colors bg-transparent cursor-pointer'
                : 'text-gray-400 hover:text-red-600 px-3 py-2.5 transition-colors bg-transparent opacity-0 group-hover:opacity-100 cursor-pointer'"
            title="Löschen"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        </button>
        <!-- button for repo editing, starts editing process with edit modal -->
        <button
            (click)="startEditRepo(repo)"
            [class]="selRepo() === repo.repoName
                ? 'text-orange-600 hover:text-orange-800 px-3 py-2.5 transition-colors bg-transparent cursor-pointer'
                : 'text-gray-400 hover:text-orange-500 px-3 py-2.5 transition-colors bg-transparent opacity-0 group-hover:opacity-100 cursor-pointer'"
            title="Bearbeiten"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        </button>
    </div>
    }
</nav>

<!-- Add new money repo button -->
<button
    (click)="toggleForm()"
    class="mt-4 w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg transition-colors flex items-center justify-center gap-2 shadow-sm hover:shadow-md cursor-pointer"
    title="Neues Konto erstellen"
>
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    <span class="font-medium">Neues Konto</span>
</button>

<!-- Delete Confirmation Modal -->
<app-modal
    [isOpen]="showDeleteModal()"
    [title]="'Konto löschen'"
    (close)="closeDeleteModal()"
>
    @if (repoToDelete()) {
    <div class="space-y-4">
        <p class="text-gray-700 text-lg">
            Möchten Sie dieses Konto wirklich löschen?
        </p>

        <div class="bg-gray-50 p-4 rounded-lg space-y-3">
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">Name:</span>
                <span class="text-sm text-gray-900 font-semibold">{{ repoToDelete()!.repoName }}</span>
            </div>

            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">Beschreibung:</span>
                <span class="text-sm text-gray-900">{{ repoToDelete()!.description || '-' }}</span>
            </div>

            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">Startguthaben:</span>
                <span class="text-sm text-gray-900 font-bold">
                    {{ repoToDelete()!.startBalance | number:'1.2-2' }} {{ repoToDelete()!.currency }}
                </span>
            </div>

            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">Datum:</span>
                <span class="text-sm text-gray-900">{{ repoToDelete()!.startBalanceDate | date: 'dd.MM.y' }}</span>
            </div>
        </div>

        <p class="text-sm text-red-600 font-medium">
            Warnung: Alle Umsätze in diesem Konto werden ebenfalls gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.
        </p>

        <div class="flex justify-end gap-3 pt-4">
            <button
                type="button"
                (click)="closeDeleteModal()"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
            >
                Abbrechen
            </button>
            <button
                type="button"
                (click)="confirmDeleteRepo()"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
            >
                Löschen
            </button>
        </div>
    </div>
    }
</app-modal>